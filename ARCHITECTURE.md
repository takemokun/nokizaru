# Nokizaru Architecture

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

nokizaruã¯**Modular Monolith + Clean Architecture**ã‚’æ¡ç”¨ã—ãŸSlack Botã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
niche-fetchãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å–ã‚Šå…¥ã‚ŒãŸã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§ä¿å®ˆæ€§ã®é«˜ã„è¨­è¨ˆã§ã™ã€‚

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
nokizaru/apps/bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                   # ğŸ†• APIå±¤ï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”‚   â””â”€â”€ v1/               # APIãƒãƒ¼ã‚¸ãƒ§ãƒ³1
â”‚   â”‚       â”œâ”€â”€ handler/      # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚   â”‚       â”œâ”€â”€ dto/          # Data Transfer Objects
â”‚   â”‚       â”œâ”€â”€ middleware/   # ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆç½²åæ¤œè¨¼ç­‰ï¼‰
â”‚   â”‚       â”œâ”€â”€ routes.rs     # ãƒ«ãƒ¼ãƒˆå®šç¾©
â”‚   â”‚       â””â”€â”€ container.rs  # DIã‚³ãƒ³ãƒ†ãƒŠ
â”‚   â”œâ”€â”€ application/          # ğŸ†• å…±é€šApplicationå±¤
â”‚   â”‚   â””â”€â”€ validation/       # å…±é€šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ lib.rs               # ğŸ†• ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â””â”€â”€ main.rs              # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ module/                   # ãƒ“ã‚¸ãƒã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ—§ modules/ï¼‰
â”‚   â”œâ”€â”€ slack/               # Slackçµ±åˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ domain/          # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ application/     # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
â”‚   â”‚   â””â”€â”€ infrastructure/  # Slack APIå®Ÿè£…
â”‚   â””â”€â”€ user/                # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚       â”œâ”€â”€ domain/
â”‚       â”œâ”€â”€ application/
â”‚       â””â”€â”€ infrastructure/  # Diesel ORMå®Ÿè£…
â””â”€â”€ shared/                  # å…±æœ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    â”œâ”€â”€ domain/              # å…±é€šãƒ‰ãƒ¡ã‚¤ãƒ³
    â””â”€â”€ infrastructure/      # DBæ¥ç¶šã€è¨­å®šã€ãƒ­ã‚°
```

## ğŸ¯ ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ 

### 1. APIå±¤ï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼‰

**è²¬å‹™**: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```
api/v1/
â”œâ”€â”€ handler/        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚   â””â”€â”€ slack.rs   # Slackã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚³ãƒãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”œâ”€â”€ dto/           # Data Transfer Objects
â”‚   â””â”€â”€ slack.rs   # Request/Response DTO
â”œâ”€â”€ middleware/    # ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
â”‚   â””â”€â”€ signature.rs # Slackç½²åæ¤œè¨¼
â”œâ”€â”€ container.rs   # DIã‚³ãƒ³ãƒ†ãƒŠï¼ˆä¾å­˜æ³¨å…¥ç®¡ç†ï¼‰
â””â”€â”€ routes.rs      # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®šç¾©
```

**ç‰¹å¾´**:
- âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰å®Œå…¨åˆ†é›¢
- âœ… APIãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å¯¾å¿œï¼ˆv1, v2...ï¼‰
- âœ… ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§æ¨ªæ–­çš„é–¢å¿ƒäº‹ã‚’å‡¦ç†
- âœ… DTOã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã¨APIä»•æ§˜ã‚’åˆ†é›¢

### 2. Applicationå±¤ï¼ˆå…±é€šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼‰

**è²¬å‹™**: å…±é€šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€å…±é€šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

```
application/
â””â”€â”€ validation/
    â””â”€â”€ slack.rs   # Slacké–¢é€£ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```

**ç‰¹å¾´**:
- âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¨ªæ–­ã®å…±é€šãƒ­ã‚¸ãƒƒã‚¯
- âœ… å†åˆ©ç”¨å¯èƒ½ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã«ä¾å­˜ã—ãªã„ç´”ç²‹ãªå‡¦ç†

### 3. Moduleå±¤ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰

**è²¬å‹™**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆClean Architectureï¼‰

å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å®Œå…¨ãªClean Architectureæ§‹é€ ï¼š

```
module/slack/
â”œâ”€â”€ domain/              # ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼ˆä¾å­˜ãªã—ï¼‰
â”‚   â”œâ”€â”€ models.rs       # ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ services.rs     # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ repositories.rs # ãƒªãƒã‚¸ãƒˆãƒªIF
â”‚   â””â”€â”€ errors.rs       # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼
â”œâ”€â”€ application/         # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤
â”‚   â””â”€â”€ usecase.rs    # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
â””â”€â”€ infrastructure/      # ã‚¤ãƒ³ãƒ•ãƒ©å±¤
    â”œâ”€â”€ client.rs       # Slack APIå®Ÿè£…
    â””â”€â”€ signature.rs    # ç½²åæ¤œè¨¼å®Ÿè£…
```

**ä¾å­˜æ–¹å‘**:
```
infrastructure â†’ application â†’ domain
```

### 4. Sharedå±¤ï¼ˆå…±æœ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰

**è²¬å‹™**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¨ªæ–­ã®å…±é€šã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³

```
shared/
â”œâ”€â”€ domain/              # å…±é€šãƒ‰ãƒ¡ã‚¤ãƒ³
â”‚   â”œâ”€â”€ value_objects.rs # å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
â”‚   â””â”€â”€ errors.rs       # å…±é€šã‚¨ãƒ©ãƒ¼
â””â”€â”€ infrastructure/      # å…±é€šã‚¤ãƒ³ãƒ•ãƒ©
    â”œâ”€â”€ database.rs     # DBæ¥ç¶šãƒ—ãƒ¼ãƒ«
    â”œâ”€â”€ schema.rs       # Dieselã‚¹ã‚­ãƒ¼ãƒ
    â”œâ”€â”€ config.rs       # è¨­å®šç®¡ç†
    â””â”€â”€ logging.rs      # ãƒ­ã‚®ãƒ³ã‚°
```

## ğŸ”„ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼

```
HTTP Request
    â†“
[APIå±¤] handler â†’ DTOå¤‰æ›
    â†“
[Applicationå±¤] validation
    â†“
[Moduleå±¤] Usecase â†’ DomainService â†’ Repository
    â†“
[Infrastructureå±¤] Diesel/Slack API
    â†“
[APIå±¤] DTOå¤‰æ› â†’ Response
    â†“
HTTP Response
```

## ğŸ’‰ ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰

### DIã‚³ãƒ³ãƒ†ãƒŠ (`api/v1/container.rs`)

```rust
pub struct AppContainer {
    pub process_event_usecase: Arc<ProcessEventUsecase>,
    pub execute_command_usecase: Arc<ExecuteCommandUsecase>,
    pub user_service: Arc<UserService>,
    pub config: Arc<AppConfig>,
}
```

**åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼**:
1. è¨­å®šèª­ã¿è¾¼ã¿ (`AppConfig::from_env()`)
2. DBæ¥ç¶šãƒ—ãƒ¼ãƒ«ä½œæˆ (`create_pool()`)
3. DIã‚³ãƒ³ãƒ†ãƒŠæ§‹ç¯‰ (`AppContainer::new()`)
4. ãƒ«ãƒ¼ã‚¿ãƒ¼æ§‹ç¯‰ (`create_router()`)

## ğŸ§ª ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£

### lib.rsã«ã‚ˆã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¬é–‹

```rust
// lib.rs
pub mod api;
pub mod application;

pub use api::{AppContainer, create_router};
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®¹æ˜“
- âœ… çµ±åˆãƒ†ã‚¹ãƒˆå¯èƒ½
- âœ… ãƒ¢ãƒƒã‚¯DIå¯èƒ½

## ğŸ“Š æ¯”è¼ƒ: Before â†’ After

| è¦ç´  | Before | After |
|------|--------|-------|
| APIå±¤ | âŒ handlersæ··åœ¨ | âœ… `api/v1/` |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° | âŒ ãªã— | âœ… v1å¯¾å¿œ |
| DIã‚³ãƒ³ãƒ†ãƒŠ | âŒ `main.rs`é›†ä¸­ | âœ… `container.rs` |
| å…±é€šapplication | âŒ ãªã— | âœ… `application/` |
| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å | `modules/` | `module/` |
| lib.rs | âŒ ãªã— | âœ… ã‚ã‚Š |

## ğŸš€ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### API v2è¿½åŠ 

```
api/
â”œâ”€â”€ v1/
â””â”€â”€ v2/          # æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½åŠ 
    â”œâ”€â”€ handler/
    â”œâ”€â”€ dto/
    â””â”€â”€ routes.rs
```

### æ–°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 

```
module/
â”œâ”€â”€ slack/
â”œâ”€â”€ user/
â””â”€â”€ analytics/   # æ–°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 
    â”œâ”€â”€ domain/
    â”œâ”€â”€ application/
    â””â”€â”€ infrastructure/
```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **ç½²åæ¤œè¨¼**: `api/v1/middleware/signature.rs`
- **ç’°å¢ƒå¤‰æ•°ç®¡ç†**: `shared/infrastructure/config.rs`
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å„å±¤ã§é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‹

## ğŸ“š å‚è€ƒ

- **ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: niche-fetch backend
- **è¨­è¨ˆåŸå‰‡**: Clean Architecture, DDD
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Axum, Diesel, Tokio
